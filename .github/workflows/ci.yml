name: CI

on:
    pull_request:
        branches: [main]

jobs:
    lint:
        name: Lint Typescript
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  repository: ${{ github.event.pull_request.head.repo.full_name }}

            - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
              with:
                  version: 10

            - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
              with:
                  node-version-file: .nvmrc

            - run: pnpm install

            - uses: ./.github/actions/lint

    build-and-test:
        strategy:
            matrix:
                version: [20, 22, 24]
                os: [ubuntu-latest, windows-latest, macos-latest]
        name: Build & Test
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  repository: ${{ github.event.pull_request.head.repo.full_name }}

            - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
              with:
                  version: 10

            - name: Setup Node
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
              with:
                  node-version: ${{ matrix.version }}

            - name: Install dependencies
              run: pnpm install

            - name: Build
              run: npm run build:debug

            - name: Test
              run: npm run test -- --run
              # `--run` disables watch mode in Vitest

    ci-pass:
        name: Integration Done
        runs-on: ubuntu-latest
        needs: [lint, build-and-test]
        steps:
            - run: echo "Build, test, & linting complete! ðŸŽ‰"
